name: Release Extension

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build release archive
        run: |
          # Use our build script
          chmod +x scripts/build-release.sh
          ./scripts/build-release.sh

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: PubMed Gemini Extension ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## PubMed Gemini Extension ${{ steps.get_version.outputs.VERSION }}
            
            ### Installation
            
            **Option 1: Official Gemini CLI**
            ```bash
            gemini extensions install github:avivlyweb/pubmed-gemini-extension
            ```
            
            **Option 2: Quick Install Script**
            ```bash
            curl -fsSL https://raw.githubusercontent.com/avivlyweb/pubmed-gemini-extension/main/install.sh | bash
            ```
            
            ### What's New
            See [CHANGELOG.md](https://github.com/avivlyweb/pubmed-gemini-extension/blob/main/CHANGELOG.md) for details.
            
            ---
            Made by Aviv at Avivly (physiotherapy.ai)
          files: release/pubmed-gemini.tar.gz
          generate_release_notes: true
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Test installation after release
  test-install:
    needs: release
    runs-on: ubuntu-latest
    if: ${{ !contains(github.ref, 'beta') && !contains(github.ref, 'alpha') }}

    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Gemini CLI
        run: |
          npm install -g @google/gemini-cli || echo "Gemini CLI install skipped"

      - name: Verify release asset exists
        run: |
          # Check that the release was created with the archive
          curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | grep "pubmed-gemini.tar.gz" && echo "âœ… Release archive found"
